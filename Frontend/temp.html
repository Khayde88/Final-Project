<!---->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Grocery App</title>
</head>
<body>
    <h1>Welcome to My Grocery App</h1>

    <!-- Add a link/button to navigate to EL.html -->
    <a href="/el">Go to Edit Lists</a>
    
    <!-- Form to submit data to MongoDB -->
    <form id="mongodb-form">
        <label for="user-input">Enter your data:</label><br>
        <input type="text" id="user-input" name="user-input"><br>
        <button type="submit">Submit</button>
    </form>

    <!-- Display section for saved list -->
    <div>
        <h2>Saved List</h2>
        <ul id="saved-list"></ul>
    </div>

    <script>
        document.getElementById("mongodb-form").addEventListener("submit", function(event) {
            event.preventDefault(); // Prevent the default form submission
            
            // Get user input from the textbox
            const userInput = document.getElementById("user-input").value;

            // Send user input to the FastAPI endpoint
            fetch('/run-script', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: new URLSearchParams({
                    'input_data': userInput
                })
            })
            .then(response => response.json())
            .then(data => {
                console.log(data);
                alert('Data sent to MongoDB!');
                location.reload(); // Reload the page to reflect the updated list
            })
            //Clear the textbox after submission
            .then(() => document.getElementById("user-input").value = "")
            .catch(error => console.error('Error:', error));
        });


        // Function to delete an item from the saved list
        function deleteItem(itemId) {
            fetch(`/delete-saved-item/${itemId}`, {
                method: 'DELETE'
            })
            .then(response => {
                if (response.ok) {
                    location.reload(); // Reload the page to reflect the updated list
                } else {
                    console.error('Error deleting item');
                }
            })
            .catch(error => console.error('Error:', error));
        }

        // Fetch and display the saved list from MongoDB
        fetch('/read-saved-list')
        .then(response => response.json())
        .then(data => {
            const savedListElement = document.getElementById('saved-list');
            data.forEach(item => {
                const listItem = document.createElement('li');
                listItem.textContent = `date: ${item.date}, stores: ${item.stores.join(', ')}, location: ${item.location}`;
                
                // Add a delete button/icon
                const deleteButton = document.createElement('button');
                deleteButton.textContent = '❌';
                deleteButton.onclick = () => deleteItem(item._id);
                
                listItem.appendChild(deleteButton);
                savedListElement.appendChild(listItem);
            });
        })
        .catch(error => console.error('Error:', error));
    </script>

    <div>
        <h2>Grocery Items</h2>
        <ul id="grocery-items"></ul>
    </div>

    <script>
        // Function to delete an item from the grocery list
        function deleteItem(itemId) {
            fetch(`/delete-grocery-item/${itemId}`, {
                method: 'DELETE'
            })
            .then(response => {
                if (response.ok) {
                    location.reload(); // Reload the page to reflect the updated list
                } else {
                    console.error('Error deleting item');
                }
            })
            .catch(error => console.error('Error:', error));
        }

        // Fetch and display the grocery items from MongoDB
        fetch('/read-grocery-items')
        .then(response => response.json())
        .then(data => {
            const groceryItemsElement = document.getElementById('grocery-items');
            data.forEach(item => {
                const listItem = document.createElement('li');
                listItem.textContent = `Name: ${item.name}, Price: ${item.price}, Category: ${item.category}, Brand: ${item.brand}, Quantity: ${item.quantity}`;
                
                // Add a delete button/icon
                const deleteButton = document.createElement('button');
                deleteButton.textContent = '❌';
                deleteButton.onclick = () => deleteItem(item._id);
                
                listItem.appendChild(deleteButton);
                groceryItemsElement.appendChild(listItem);
            });
        })
        .catch(error => console.error('Error:', error));

    </script>

</body>
</html>

@app.post("/run-script")
def run_script(input_data: str = Form(...)):
    # Connect to MongoDB
    client = MongoClient('mongodb+srv://canderson32:Kotaikanaxai_88@cluster0.dswl3pn.mongodb.net/?retryWrites=true&w=majority&appName=Cluster0')
    db = client['grocery_db']
    collection = db['grocery_items']

    # Write data to MongoDB
    data = {"input": input_data}
    collection.insert_one(data)

    # Write data to MongoDB using pymongo
    myclient = pymongo.MongoClient("mongodb+srv://canderson32:Kotaikanaxai_88@cluster0.dswl3pn.mongodb.net/?retryWrites=true&w=majority&appName=Cluster0")
    mydb = myclient["grocery_db"]
    mycol = mydb["SavedList"]

    mydict = {
        "date": "1/15/2023",
        "stores": ["Target", "Whole Foods Market", "Fareway"],
        "location": "Delete_test_2"
    }

    x = mycol.insert_one(mydict)

    return {"message": "Data written to MongoDB successfully"}

    # Initialize logging
    logging.basicConfig(level=logging.INFO)
    logger = logging.getLogger(__name__)
    
    app = FastAPI()
    
    app.add_middleware(
        CORSMiddleware,
        allow_origins=["*"],  # Allows all origins
        allow_credentials=True,
        allow_methods=["*"],  # Allows all methods
        allow_headers=["*"],  # Allows all headers
    )
    
    class StoreItem(Document):
        date: str
        stores: List[str]
        location: str
    
        class Settings:
            collection = "store_items"
    
    # Initialize Beanie with the StoreItem Document model
    @app.on_event("startup")
    async def init_db():
        client = AsyncIOMotorClient("mongodb+srv://canderson32:Kotaikanaxai_88@cluster0.dswl3pn.mongodb.net/?retryWrites=true&w=majority&appName=Cluster0")
        await init_beanie(database=client.grocery_db, document_models=[StoreItem])
        logger.info("Beanie initialized successfully")
    
    # CRUD Endpoints
    @app.post("/items/", response_model=StoreItem)
    async def create_item(item: StoreItem):
        await item.insert()
        logger.info("Item created successfully")
        return item
    
    @app.get("/items/")
    async def get_items():
        items = await StoreItem.find_all().to_list()
        logger.info("Items retrieved successfully")
        return items
    
    @app.delete("/delete/{item_id}")
    async def delete_item(item_id: PydanticObjectId):
        item = await StoreItem.get(item_id)
        if item:
            await item.delete()
            logger.info(f"Item with ID {item_id} deleted successfully")
            return {"message": "Item deleted successfully"}
        raise HTTPException(status_code=404, detail="Item not found")
    
    @app.get("/")
    async def read_index():
        return FileResponse("./Frontend/Home.html")
    
    @app.get("/index")
    async def read_profile():
        logger.info("Index file requested")
        return FileResponse("./Frontend/index.html")
    
    @app.get("/inputgenerated")
    async def read_input_generated():
        return FileResponse("./Frontend/InputGenerated.html")
    
    @app.get("/listcomplete")
    async def read_list_complete():
        return FileResponse("./Frontend/ListComplete.html")
    
    @app.get("/profile")
    async def read_profile():
        return FileResponse("./Frontend/Profile.html")
    
    @app.get("/priceupdate")
    async def read_price_update():
        return FileResponse("./Frontend/PriceUpdate.html")
    
    @app.get("/filter")
    async def read_filter():
        return FileResponse("./Frontend/Filter.html")
    
    @app.get("/sl1")
    async def read_sl1():
        return FileResponse("./Frontend/SL1.html")
    #navigate to EL.html
    @app.get("/el")
    async def read_el():
        logger.info("EL file requested")
        return FileResponse("./Frontend/EL.html")
    
    # Trying to get the input from the user
    
    
    @app.get("/read-saved-list")
    async def read_saved_list():
        # Connect to MongoDB
        client = pymongo.MongoClient("mongodb+srv://canderson32:Kotaikanaxai_88@cluster0.dswl3pn.mongodb.net/?retryWrites=true&w=majority&appName=Cluster0")
        db = client["grocery_db"]
        col = db["SavedList"]
    
        # Retrieve data from MongoDB
        saved_data = list(col.find())
    
        # Convert ObjectId to string in each item
        for item in saved_data:
            item['_id'] = str(item['_id'])
    
        # Return the retrieved data
        return saved_data
    
    @app.delete("/delete-saved-item/{item_id}")
    async def delete_saved_item(item_id: str):
        # Connect to MongoDB
        client = pymongo.MongoClient("mongodb+srv://canderson32:Kotaikanaxai_88@cluster0.dswl3pn.mongodb.net/?retryWrites=true&w=majority&appName=Cluster0")
        db = client["grocery_db"]
        col = db["SavedList"]
    
        # Convert item_id to ObjectId
        try:
            obj_id = ObjectId(item_id)
        except:
            raise HTTPException(status_code=400, detail="Invalid item ID")
    
        # Delete item from MongoDB
        result = col.delete_one({"_id": obj_id})
    
        if result.deleted_count == 1:
            return {"message": "Item deleted successfully"}
        else:
            raise HTTPException(status_code=404, detail="Item not found")
    
    # Import necessary modules
    from fastapi import HTTPException
    
    # # Update endpoint for modifying existing items
    # @app.put("/update/{item_id}")
    # async def update_item(item_id: PydanticObjectId, updated_item: StoreItem):
    #     # Log the received item ID
    #     logger.info(f"Received request to update item with ID: {item_id}")
    #     # Get the existing item
    #     existing_item = await StoreItem.get(item_id)
        
    #     # If the item doesn't exist, raise HTTPException
    #     if not existing_item:
    #         logger.error(f"Item with ID {item_id} not found")
    #         raise HTTPException(status_code=404, detail="Item not found")
        
    #     # Update the fields of the existing item
    #     existing_item.date = updated_item.date
    #     existing_item.stores = updated_item.stores
    #     existing_item.location = updated_item.location
        
    #     # Save the updated item
    #     await existing_item.save()
    #     logger.info(f"Item with ID {item_id} updated successfully")
    #     return existing_item
